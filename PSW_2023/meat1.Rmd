##
## Szablon do różnych wykresów
## Pakiety
#library("FAOSTAT")


library("ggplot2") ## funkcje rysujące
library("dplyr") ## redukcja danych filter/selecy
library("tidyr") ## funkcje transformacji danych
library("scales") ## definiowanie skal
##library("ggthemes") ## wyjaśnione/dołączone niżej
##library("ggpubr") ## łącznie wykresów w jeden rysunek


```{r}
items.of.interest <- c( 'Meat', 'Animal Products', 'Grand Total', 'Population')
units.of.interest <- c('FoodS (kcal/c/d)', 'ProtSQ (g/c/d)', 
                       'FoodSQ (kg/c/y)', 'TotalPop')
years <- c('2010', '2020')

fao.aggregates <- c("001", "002", "014", "017", "015", "018", "011", "019",
"021", "013", "029", "005", "142", "143", "030", "034", "035", "145", "150",
"151", "154", "039", "155", "009", "053", "054", "097", "199", "432", "722",
"901", "902")
```

## Introduction

Why we should eat less meat?

* Becuase it is unhealthy

* Becuase [production] it is economically inefficient

* Because [production] is harmful to environment


## Data

There is such a beast as FAO food balance sheet

Data on per capita supply at a retail level of various food items

Calculate as: production + import + stocks - (export + feeding + non-food usage
+ wastage + closing stocks)

The difference divided by population is per capita consumption

The balance is mantained from 1961 but in 2010 there was
a methodology change

Up to you to assess the precision :-)

## FBS

* items and item groups (such as Meat Products)

* measured as: daily per capita energy supply (kcal/c/d),
daily per capita protein supply (g/c/d),
daily per capita fat supply (g/c/d),
or
daily per capita quantity supply (kg/c/year)

* we use the following item groups: Meat, Animal Products
(Meat + Eggs + Dairy products, Honey etc...),
Total Products (ie. total per capita consumption)

* https://www.fao.org/faostat/en/#data/FBS


## Results

We enhance FBS with GDP data from the World Bank and use
World Bank Income Groups

GNI per capita, Atlas method (current USD)
https://data.worldbank.org/indicator/NY.GNP.PCAP.CD

| GNI         | Income Group |
|-------------|--------------|
| 0--1084     | low          |
| 1085--4254  | lower-middle |
| 4255--13204 | upper-middle |
| 13205--     | high         |
|-------------|--------------|


```{r}
o0 <- read.csv(file='FoodBalance2023.csv',sep=';', 
               colClasses=c( CodeM49 ="character"),
               header=T) %>%
  filter (YearCode %in% years ) %>%
  filter (Item %in% items.of.interest) %>%
  filter (Element %in% units.of.interest)

## PL
## o.pl <- o0 %>% filter (CodeM49 == '616') 
 
## około 130 krajów o liczbie ludności > 3mln (w 2020)
## pull zamienia na listę
big.countries.2020 <- o0 %>% filter(YearCode == 2020 ) %>%
   filter (Item == 'Population' & Value > 3000) %>%
    filter (! CodeM49 %in% fao.aggregates) %>%
  pull(CodeM49)

o1 <- o0 %>% filter (CodeM49 %in% big.countries.2020) 
```

We omit countries with population less than 3 mln. 

```{r}
gni0 <- read.csv(file='API_NY.GNP.PCAP.CD_DS2_en_csv_v2_5340976.csv', 
               sep=',', 
               ##colClasses=c( CodeM49 ="character"),
               header=T) %>%
  select (ISO3=Country.Code, starts_with('X')) %>%
  pivot_longer(cols = starts_with('X'), names_prefix = 'X', names_to = 'year',
               values_to = 'GNI') %>%
  mutate (year = as.numeric(year)) %>%
  drop_na() %>%
  group_by(ISO3) %>%
  summarise(ISO3 = last(ISO3), year = last(year), GNI = last (GNI))


## UNSD nie zawiera taiwanu
## unsd potrzebny do dodania ISO3
unsd <- read.csv(file='m49toIso.csv', sep=';',
                 colClasses=c( M49 ="character"), header=T) %>%
  select (CountryName, CodeM49=M49, ISO3)


o2 <- o1 %>% 
  left_join(unsd, by='CodeM49' ) %>%
  left_join(gni0, by=c('ISO3'='ISO3')) %>%
  #mutate( class=IncomeGroup)
  mutate( class=case_when( GNI < 1085 ~ "low",
                           GNI < 4255 ~ "lower-middle",
                           GNI < 13205 ~ "upper-middle",
                           GNI >= 13205 ~ "high",
                           TRUE ~ NA_character_ ) ) %>%
  drop_na(class)
```

```{r}
o2.high <- o2 %>% group_by(Area) %>%
  summarise(Area=last(Area), class=last(class)) %>%
  filter (class=='high')
N.high <- nrow(o2.high)

o2.lm <- o2 %>% group_by(Area) %>%
  summarise(Area=last(Area), class=last(class)) %>%
  filter (class=='lower-middle')
N.lm <- nrow(o2.lm)

o2.um <- o2 %>% group_by(Area) %>%
  summarise(Area=last(Area), class=last(class)) %>%
  filter (class=='upper-middle')
N.um <- nrow(o2.um)

o2.low <- o2 %>% group_by(Area) %>%
  summarise(Area=last(Area), class=last(class)) %>%
  filter (class=='low')
N.low <- nrow(o2.um)
```

There is `r N.high` countries in high-income group;
`r N.um` countries in upper-middle-income group;
`r N.lm` countries in lower-middle-income group
and 
`r N.low` countries in low-income group.


## Population

```{r}
p.pop <- o2 %>%
  filter (Item == 'Population') %>%
  group_by(class, YearCode) %>%
  summarise(population = sum(Value, na.rm = T)) %>%
  group_by(YearCode) %>%
  mutate(T = sum(population)) %>%
  group_by(class, YearCode) %>%
  summarise(p = sum(population) / T * 100 ) 
## sprawdzenie
p.pop.total <- p.pop %>%
  group_by(YearCode) %>%
  summarise(p=sum(p))
#
#
p.pop.p1 <- p.pop %>% ggplot(aes(x = class, y = p)) +
  facet_wrap(~YearCode) +
  ggtitle("World population by WB income classes") +
  geom_bar(stat='identity',  fill = "navyblue")  +
  geom_text(aes(label = sprintf ("%.1f", p)), size=3, color='white', vjust=1.5)
p.pop.p1
```



## Meat Consumption 

```{r}
p0 <- o2 %>% 
  filter (Item == 'Meat' & Element =='FoodSQ (kg/c/y)' ) %>%
  ggplot(aes(x=class, y=Value)) +
  facet_wrap(~YearCode) +
  geom_jitter(size=3, alpha=.3, position=position_jitter(0.05)) +
  geom_boxplot(outlier.shape = NA, alpha=.3, fill='yellow') +
  ylab("kg/capita/year") +
  ggtitle("Meat consumption", subtitle="")

p0

p1 <- o2 %>% 
  filter (Item == 'Meat' & Element =='FoodS (kcal/c/d)' ) %>%
  ggplot(aes(x=class, y=Value)) +
  facet_wrap(~YearCode) +
  geom_jitter(size=3, alpha=.3, position=position_jitter(0.05)) +
  geom_boxplot(outlier.shape = NA, alpha=.3, fill='yellow') +
  ylab("kcal/capita/day") +
  ggtitle("Meat consumption", subtitle="")

p1
```

## Animal Products (energy)

```{r}
p2 <- o2 %>% drop_na(class) %>%
  filter (Item == 'Animal Products' & Element =='FoodS (kcal/c/d)' ) %>%
  ggplot(aes(x=class, y=Value)) +
  facet_wrap(~YearCode) +
  geom_jitter(size=3, alpha=.3, position=position_jitter(0.05)) +
  geom_boxplot(outlier.shape = NA, alpha=.3, fill='yellow') +
  ylab("kcal/capita/day") +
  ggtitle("Animal products consumption", subtitle="")

p2


##
p3 <- o2 %>% 
  filter (Item == 'Grand Total' & Element =='FoodS (kcal/c/d)' ) %>%
  ggplot(aes(x=class, y=Value)) +
  facet_wrap(~YearCode) +
  geom_jitter(size=3, alpha=.3, position=position_jitter(0.05)) +
  geom_boxplot(outlier.shape = NA, alpha=.3, fill='yellow') +
  ylab("kcal/capita/day") +
  ggtitle("Total consumption", subtitle="")

p3
```

## Protein supply

```{r}
p1.prot <- o2 %>% 
  filter (Item == 'Meat' & Element =='ProtSQ (g/c/d)' ) %>%
  ggplot(aes(x=class, y=Value)) +
  facet_wrap(~YearCode) +
  geom_jitter(size=3, alpha=.3, position=position_jitter(0.05)) +
  geom_boxplot(outlier.shape = NA, alpha=.3, fill='yellow') +
  ylab("kcal/capita/day") +
  ggtitle("Meat Protein supply", subtitle="")

p1.prot

p2 <- o2 %>% 
  filter (Item == 'Animal Products' & Element =='FoodS (kcal/c/d)' ) %>%
  ggplot(aes(x=class, y=Value)) +
  facet_wrap(~YearCode) +
  geom_jitter(size=3, alpha=.3, position=position_jitter(0.05)) +
  geom_boxplot(outlier.shape = NA, alpha=.3, fill='yellow') +
  ylab("kcal/capita/day") +
  ggtitle("Animal products protein supply", subtitle="")

p2.prot
```

## Total supply

```{r}
p3.prot <- o2 %>% 
  filter (Item == 'Grand Total' & Element =='FoodS (kcal/c/d)' ) %>%
  ggplot(aes(x=class, y=Value)) +
  facet_wrap(~YearCode) +
  geom_jitter(size=3, alpha=.3, position=position_jitter(0.05)) +
  geom_boxplot(outlier.shape = NA, alpha=.3, fill='yellow') +
  ylab("kcal/capita/day") +
  ggtitle("Total protein supply", subtitle="")

p3.prot

## Total Consumption of meat
## kg/pc/year
o2t <- o2 %>%
  filter (Item =='Population' | (Item == 'Meat' & Element =='FoodSQ (kg/c/y)' )) %>%
  select (CodeM49, class, Item, Value, YearCode)  %>%
  pivot_wider(names_from = Item, values_from = Value) %>%
  mutate (tc = Population * Meat) %>%
  group_by(class, YearCode) %>%
  summarise(tc=sum(tc), tpop =sum(Population), pctc = tc/tpop) %>%
  ##
  group_by(YearCode) %>%
  mutate(T = sum(tc), TP = sum(tpop)) %>%
  group_by(class, YearCode) %>%
  summarise(p = sum(tc) / T * 100, pp = sum(tpop) / TP, pctc = first(pctc) ) 

o2t.p <- o2t %>% 
  ggplot(aes(x = class, y = pp)) +
  facet_wrap(~YearCode) +
  ggtitle("Meat consumption (% total)") +
  geom_bar(stat='identity',  fill = "navyblue")  +
  geom_text(aes(label = sprintf ("%.1f", p)), size=3, color='white', vjust=1.5)
o2t.p
  
o2t.pc <- o2t %>% 
  ggplot(aes(x = class, y = pctc)) +
  facet_wrap(~YearCode) +
  ggtitle("Average meat consumption (kg/capita/year)") +
  geom_bar(stat='identity',  fill = "navyblue")  +
  geom_text(aes(label = sprintf ("%.1f", pctc)), size=3, color='white', vjust=1.5)
o2t.pc


## Total Consumption of meat products
## kg/pc/year

## Consumption of animal products (total kcal/c/d)
o3t <- o2 %>%
  filter (Item =='Population' | (Item == 'Animal Products' & Element =='FoodS (kcal/c/d)' )) %>%
  select (CodeM49, class, Item, Value, YearCode)  %>%
  pivot_wider(names_from = Item, values_from = Value) %>%
   ###
  select (CodeM49, class, Population, Meat=`Animal Products`, YearCode) %>% 
  mutate (tc = Population * Meat) %>%
  group_by(class, YearCode) %>%
  summarise(tc=sum(tc), tpop =sum(Population), pctc = tc/tpop) %>%
  ##
  group_by(YearCode) %>%
  mutate(T = sum(tc), TP = sum(tpop)) %>%
  group_by(class, YearCode) %>%
  summarise(p = sum(tc) / T * 100, pp = sum(tpop) / TP, pctc = first(pctc) ) 

## Per capita change

o3r.pc.change <- o3t %>% select (class, YearCode, pctc) %>%
  pivot_wider(names_from = 'YearCode', values_from = 'pctc') %>%
  mutate (d = (`2020` - `2010`)/`2010` * 100, d1 = d/11)
 

o3t.p <- o3t %>% 
  ggplot(aes(x = class, y = pp)) +
  facet_wrap(~YearCode) +
  ggtitle("Animal products consumption (% total)") +
  geom_bar(stat='identity',  fill = "navyblue")  +
  geom_text(aes(label = sprintf ("%.1f", p)), size=3, color='white', vjust=1.5)
o3t.p

o3t.pc <- o3t %>% 
  ggplot(aes(x = class, y = pctc)) +
  facet_wrap(~YearCode) +
  ggtitle("Animal products consumption (kcal/c/d)") +
  geom_bar(stat='identity',  fill = "navyblue")  +
  geom_text(aes(label = sprintf ("%.1f", pctc)), size=3, color='white', vjust=1.5)
o3t.pc

####################
## Total consumption

o4t <- o2 %>%
  filter (Item =='Population' | (Item == 'Grand Total' & Element =='FoodS (kcal/c/d)' )) %>%
  select (CodeM49, class, Item, Value, YearCode)  %>%
  pivot_wider(names_from = Item, values_from = Value) %>%
  ###
  select (CodeM49, class, Population, Meat=`Grand Total`, YearCode) %>% 
  mutate (tc = Population * Meat) %>%
  group_by(class, YearCode) %>%
  summarise(tc=sum(tc), tpop =sum(Population), pctc = tc/tpop) %>%
  ##
  group_by(YearCode) %>%
  mutate(T = sum(tc), TP = sum(tpop)) %>%
  group_by(class, YearCode) %>%
  summarise(p = sum(tc) / T * 100, pp = sum(tpop) / TP, pctc = first(pctc), 
            tc=first(tc)/1000000 )

o4t.pc <- o4t %>% 
  ggplot(aes(x = class, y = pctc)) +
  facet_wrap(~YearCode) +
  ggtitle("Average daily consumption (kcal/c/d)") +
  geom_bar(stat='identity',  fill = "navyblue")  +
  geom_text(aes(label = sprintf ("%.1f", pctc)), size=3, color='white', vjust=1.5)
o4t.pc

## 
o4t.tt <- o4t %>% 
  ggplot(aes(x = class, y = tc)) +
  facet_wrap(~YearCode) +
  ggtitle("Total daily consumption (millions kcal/d)") +
  geom_bar(stat='identity',  fill = "navyblue")  +
  geom_text(aes(label = sprintf ("%.1f", tc)), size=3, color='white', vjust=1.5)
o4t.tt 
  
o4t.total <- o4t %>%
  group_by(YearCode) %>%
  summarise(tc = sum(tc))
```

## Mozaic plot

```{r}
```

## Schabowy Raz

Kotlet schabowy (KOHT-let s-HA-bow-vey):
in its most traditional form, this pork cutlet is coated with breadcrumbs,
fried on lard, and served with potatoes and browned or pickled cabbage. 

https://culture.pl/en/work/polish-food-101-kotlet-schabowy

And do not forget about kiełbasa (sausage)




## Environmental Kuznets Curve

The environmental Kuznets curve (EKC) is a hypothesized relationship between various indicators of environmental degradation and per capita income.

In the early stages of economic growth, pollution emissions
increase and environmental quality declines, but beyond some level
of per capita income the trend reverses, so that at high income levels,
economic growth leads to environmental improvement.

In case of meat consumption and the most basic form the relation
can be specified as:

Meat = a + b GDP + c GDP²

If a relation between Meat consumption and GDP follows EKC
it must has a turning point, ie. an income level above which
the consumption of meat decreases.


```{r}
##
## Consumption = GDP + Urbanization
## --------------------------------
## SP.URB.TOTL.IN.ZS = Urban population (%)
## NY.GNP.PCAP.CD = GNI per capita

## GDP
z0 <- read.csv(file='API_NY.GNP.PCAP.CD_DS2_en_csv_v2_5340976.csv', 
               sep=',', 
               ##colClasses=c( CodeM49 ="character"),
               header=T) %>%
  select (ISO3=Country.Code, starts_with('X')) %>%
  pivot_longer(cols = starts_with('X'), names_prefix = 'X', names_to = 'year',
               values_to = 'gnp') %>%
  filter (year %in% years ) 


o2x <- o2 %>%
  left_join(u0, by=c('ISO3', 'YearCode'='year'))

o2xx <- o2x %>% filter (YearCode == 2020) %>%
  filter (Item == 'Grand Total' & Element =='FoodS (kcal/c/d)' )
##
#o2x.2020.meat <- o2x %>% filter (YearCode == 2020) %>%
#  filter (Item == 'Grand Total' & Element =='FoodS (kcal/c/d)' )
#
#model0 <- lm(data=o2x.2020.meat, log(Value) ~ log(GNI)  )
#summary(model0)
#
#o2x.2020.meat.h <- o2x.2020.meat %>% filter (class == 'high')

f1 <- ggplot(o2xx, aes(x= GNI,  y=Value )) +
  geom_point(size=2.5, alpha=.3) +
  geom_smooth(method = lm) +
  xlab(label="") +
facet_wrap(~ class, scales = "free" )

f1


f1u <- ggplot(o2xx, aes(x= up,  y=Value )) +
  geom_point(size=2.5, alpha=.3) +
  geom_smooth(method = lm) +
  xlab(label="") +
  facet_wrap(~ class, scales = "free" )

f1u

####### Animal products

o2xx <- o2x %>% filter (YearCode == 2020) %>%
  filter (Item == 'Animal Products' & Element =='FoodS (kcal/c/d)' )

f2 <- ggplot(o2xx, aes(x= GNI,  y=Value )) +
  geom_point(size=2.5, alpha=.3) +
  geom_smooth(method = lm) +
  xlab(label="") +
  facet_wrap(~ class, scales = "free" )

f2

model0 <- lm(data=o2xx, Value ~ GNI  )
summary(model0)

model1 <- lm(data=o2xx, Value ~ GNI + I(GNI^2) )
summary(model1)
apex <- coef(model1)[2] / (-2*coef(model1)[3])
apex
apex.y = coef(model1)[1] + coef(model1)[2] * apex + coef(model1)[3] * apex^2
## https://www.geeksforgeeks.org/polynomial-regression-in-r-programming/
apex.y
ggplot(o2xx, aes(GNI, Value) ) + geom_point() +
  stat_smooth(method = lm, formula = y ~ poly(x, 2)) +
  annotate("point", x = apex, y = apex.y, colour = "red", size=4) +
  annotate("text", x = apex, y = apex.y, colour = "red", size=4, 
           label=sprintf ("%.0f", apex), vjust=2)

## how many countries has GNI > 52 tys


f2u <- ggplot(o2xx, aes(x= up,  y=Value )) +
  geom_point(size=2.5, alpha=.3) +
  geom_smooth(method = lm) +
  xlab(label="") +
  facet_wrap(~ class, scales = "free" )

f2u
```

## Bibliography

Cole J.R., McCoskey S.,
*Does global meat consumption follow an environmental Kuznets curve*
Sustainability: Science, Practice, and Policy 9/2 (2017), pp. 26--36
https://www.tandfonline.com/doi/abs/10.1080/15487733.2013.11908112

Sans P., Combris P.,
*World meat consumption patters: An overview of the last fifty years (1961--2011)*
Meat Science 2015

Przechlewski T.
*Meat and animal products consumption trends 2010--2020. Exploratory analysis*
Oblicza Dobrobytu 2023 (In Press)

